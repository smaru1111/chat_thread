# 02. Requirements - 機能要件と非機能要件

## 📋 概要

このドキュメントは、**「ユーザーが最終的に何をできるようになるか」** を明示する「単一の真実（Single Source of Truth）」です。

仕様変更時は必ずこのファイルを更新し、設計と実装の整合性を保ちます。

---

## 🎯 機能要件
### FR-Auth: 認証・ユーザー管理

#### FR-Auth.1: ユーザー登録/ログイン
- **説明**: ユーザーはメール+パスワード、またはOAuthでサインアップ/ログインできる（Remix Auth + Supabaseを使用）
- **優先度**: 必須（P0）
- **受入基準**:
  - サインアップ/ログインAPIが提供され、成功時にセッションが発行される
  - 無効な資格情報ではエラーを返す

#### FR-Auth.2: セッション管理
- **説明**: Cookieベースのセッションで認証状態を維持する（HttpOnly, Secure, SameSite=Lax/Strict）
- **優先度**: 必須（P0）
- **受入基準**:
  - 認証が必要なAPIは認証なしでアクセスできない
  - セッション破棄（ログアウト）ができる

#### FR-Auth.3: アクセス制御
- **説明**: 会話・メッセージは作成ユーザーのみが読み書きできる
- **優先度**: 必須（P0）
- **受入基準**:
  - `conversations.user_id` と現在のユーザーが一致しない場合は 403 を返す
  - メッセージ作成・取得でも同様に所有者チェックが行われる

### FR-1: ツリー構造の会話管理

#### FR-1.1: メッセージの親子関係管理
- **説明**: 各メッセージは `parentMessageId` を持ち、どのメッセージから派生したかを記録する
- **優先度**: 必須（P0）
- **メッセージ階層の定義**:
  - **0階層目メッセージ**: `parentMessageId = null` のメッセージ。会話の「一番上の段」に時間順（作成日時順）で並ぶ
  - **子メッセージ**: `parentMessageId` が設定されているメッセージ。親メッセージから派生したスレッドを形成
  - **ツリーの最上段メッセージ**: あるメッセージから `parentMessageId` を遡ったときに最初に到達する0階層目メッセージ。そのメッセージが属するツリーの起点となる
- **受入基準**:
  - メッセージ作成時に親メッセージIDを指定できる
  - 親メッセージが存在しない場合（0階層目メッセージ）も扱える
  - メッセージツリー全体を一貫して管理できる
  - 0階層目メッセージが作成日時順に正しく管理される
  - 各メッセージが属するツリーの最上段メッセージを特定できる

#### FR-1.2: 会話ツリーの取得
- **説明**: 指定されたメッセージを起点として、その子孫メッセージを含むツリー構造を取得できる
- **優先度**: 必須（P0）
- **受入基準**:
  - 任意のメッセージIDから、そのメッセージ以下のツリーを取得できる
  - ツリー構造が正しく再現される（親子関係が保持される）

---

### FR-2: 任意のメッセージからの対話再開

#### FR-2.1: メッセージからの分岐作成
- **説明**: ユーザーは過去の任意のメッセージを選択し、そこから新しいスレッド（分岐）を開始できる
- **優先度**: 必須（P0）
- **受入基準**:
  - UI上で過去のメッセージを選択できる
  - 選択したメッセージを親として、新しいメッセージを作成できる
  - 既存のスレッドに影響を与えずに分岐できる

#### FR-2.2: 複数スレッドの並列管理
- **説明**: 一つの会話セッション内で、複数の独立したスレッドを並列に管理できる
- **優先度**: 必須（P0）
- **受入基準**:
  - 複数のスレッドが同時に存在できる
  - 各スレッドは独立して展開できる
  - スレッド間で情報が混線しない

---

### FR-3: LLMへのコンテキスト送信

#### FR-3.1: コンテキストメッセージの自動抽出
- **説明**: 選択されたメッセージ `m` に対して、LLMに送信するコンテキストメッセージを自動的に抽出する
- **優先度**: 必須（P0）
- **コンテキストの定義**:
  1. **ツリーの最上段メッセージの特定**: メッセージ `m` から `parentMessageId` を遡り、最初に `parentMessageId = null` になるメッセージ `Rk` を特定（`Rk` は `m` が属するツリーの最上段メッセージ）
  2. **0階層目メッセージの取得**: `parentMessageId = null` のメッセージのうち、`Rk` の作成日時以前のものを時間順に取得（`[R1, R2, ..., Rk]`）
     - 注意: `Rk` より後の0階層目メッセージは含めない
  3. **祖先チェーンの取得**: `Rk` から `m` までの祖先チェーンを取得（`AncestorChain(m) = [Rk = a0, a1, a2, ..., aL = m]`）
     - 分岐したスレッドのメッセージは含まれない（選択した枝だけ）
  4. **コンテキストの構築**: 
     - `[R1, R2, ..., Rk]`（0階層目で、`Rk` の作成日時以前のもの）
     - `[a1, a2, ..., aL]`（`Rk` を除いた祖先チェーン）
     - これらを結合したものがコンテキスト（`Rk` は重複しない）
- **重要な制約**:
  - `Rk` より後の0階層目メッセージ（`Rk+1, Rk+2, ...`）はコンテキストに含めない
  - 会話全体ではなく、`m` が属するツリーの最上段メッセージ（`Rk`）の作成日時以前の0階層目だけを含める
  - 時間順の判定は作成日時（`created_at`）に基づく
- **受入基準**:
  - 指定されたメッセージから、ツリーの最上段メッセージ（`Rk`）を正しく特定できる
  - 0階層目メッセージのうち、`Rk` の作成日時以前のものを正しく取得できる
  - 祖先チェーンが正しく構築される（`Rk` から `m` まで）
  - コンテキストが正しい順序で構築される（`[R1, ..., Rk]` + `[a1, ..., aL]`、`Rk` は重複しない）
  - 分岐したスレッドのメッセージは含まれない（選択した枝だけ）

#### FR-3.2: LLM APIへの送信
- **説明**: 抽出した先祖メッセージを、LLM API（OpenAI等）に適切な形式で送信する
- **優先度**: 必須（P0）
- **受入基準**:
  - メッセージをLLM APIの期待する形式（role, content等）に変換できる
  - トークン制限を考慮した送信ができる（必要に応じて切り詰め）
  - レスポンスを正しく受信し、新しいメッセージとして保存できる

---

### FR-4: 会話ツリーの表示

#### FR-4.1: ツリー構造の可視化
- **説明**: 会話ツリーを視覚的に表示し、ユーザーが構造を理解できる
- **優先度**: 高（P1）
- **受入基準**:
  - メッセージの親子関係が視覚的に分かる
  - スレッドの分岐が明確に表示される
  - ツリー全体をスクロール・ナビゲートできる

#### FR-4.2: メッセージの選択と操作
- **説明**: ユーザーは表示されたメッセージを選択し、そこから新しいスレッドを開始できる
- **優先度**: 必須（P0）
- **受入基準**:
  - メッセージをクリック/タップして選択できる
  - 選択したメッセージから「続ける」操作ができる
  - 選択状態が視覚的に分かる

---

### FR-5: メッセージの基本操作

#### FR-5.1: メッセージの作成
- **説明**: ユーザーが新しいメッセージ（ユーザーメッセージ）を作成できる
- **優先度**: 必須（P0）
- **受入基準**:
  - テキスト入力欄からメッセージを作成できる
  - 親メッセージIDを指定して作成できる
  - メッセージが正しく保存される

#### FR-5.2: メッセージの表示
- **説明**: 保存されたメッセージを表示できる
- **優先度**: 必須（P0）
- **受入基準**:
  - メッセージの内容（テキスト）が表示される
  - メッセージの作成日時が表示される
  - ユーザーメッセージとLLMレスポンスが区別できる

#### FR-5.3: メッセージの編集・削除（将来機能）
- **説明**: 作成したメッセージを編集・削除できる
- **優先度**: 低（P2）
- **備考**: MVPでは実装しないが、将来の拡張として検討

---

### FR-6: 会話セッション管理

#### FR-6.1: セッションの作成
- **説明**: 新しい会話セッションを作成できる
- **優先度**: 必須（P0）
- **受入基準**:
  - セッション名を指定して作成できる
  - セッションが一意のIDで識別される

#### FR-6.2: セッションの一覧表示
- **説明**: 作成したセッションの一覧を表示できる
- **優先度**: 高（P1）
- **受入基準**:
  - セッション一覧が表示される
  - セッション名、作成日時、最終更新日時が表示される

#### FR-6.3: セッションの選択と読み込み
- **説明**: 既存のセッションを選択し、その会話ツリーを読み込める
- **優先度**: 必須（P0）
- **受入基準**:
  - セッションを選択すると、そのセッションの会話ツリーが表示される
  - ツリー構造が正しく復元される

---

## 🔧 非機能要件

### NFR-1: パフォーマンス

#### NFR-1.1: レスポンス時間
- **説明**: ユーザー操作に対する応答時間
- **要件**:
  - メッセージ送信からLLMレスポンス受信まで: 10秒以内（LLM APIの応答時間に依存）
  - UI操作（クリック、スクロール等）: 100ms以内
  - ツリー構造の取得・表示: 1秒以内（100メッセージ程度まで）

#### NFR-1.2: スケーラビリティ
- **説明**: 大量のメッセージを扱えること
- **要件**:
  - 1セッションあたり1000メッセージまで扱える（初期目標）
  - ツリー構造の取得が線形時間で実行できる

---

### NFR-2: データ永続化

#### NFR-2.1: データベース
- **説明**: メッセージとセッションのデータを永続化する
- **要件**:
  - メッセージとセッションが確実に保存される
  - データの整合性が保たれる（親子関係が正しく維持される）
  - トランザクション処理が適切に行われる

#### NFR-2.2: データの復元
- **説明**: アプリ再起動後もデータが復元される
- **要件**:
  - セッションとメッセージが正しく読み込まれる
  - ツリー構造が完全に復元される

---

### NFR-3: セキュリティ

#### NFR-3.1: APIキーの管理
- **説明**: LLM APIキーを安全に管理する
- **要件**:
  - APIキーが環境変数や設定ファイルで管理される
  - APIキーがコードにハードコードされない
  - 必要に応じてユーザーがAPIキーを設定できる

#### NFR-3.2: データのプライバシー
- **説明**: ユーザーの会話データを適切に保護する
- **要件**:
  - 会話データが外部に漏洩しない（初期はローカル保存を想定）
  - 必要に応じてデータの暗号化を検討

---

### NFR-4: ユーザビリティ

#### NFR-4.1: 直感的な操作
- **説明**: ユーザーが直感的に操作できるUI
- **要件**:
  - メッセージからの分岐操作が明確に分かる
  - ツリー構造が理解しやすい
  - エラーメッセージが分かりやすい

#### NFR-4.2: レスポンシブデザイン
- **説明**: 様々な画面サイズに対応する
- **要件**:
  - デスクトップ（1920x1080以上）で快適に使える
  - タブレット（768px以上）でも基本的な操作ができる
  - モバイル（初期は非対応でも可）

---

### NFR-5: 拡張性

#### NFR-5.1: LLMプロバイダーの切り替え
- **説明**: 異なるLLMプロバイダー（OpenAI、Anthropic、Google等）に対応できる
- **要件**:
  - LLM APIの抽象化レイヤーを用意する
  - 設定でプロバイダーを切り替えられる

#### NFR-5.2: 機能の追加
- **説明**: 将来的な機能追加に対応できる設計
- **要件**:
  - モジュール化された設計
  - 新機能を既存機能に影響を与えずに追加できる

---

## 📊 優先度定義

- **P0（必須）**: MVPに必須の機能。これがないとアプリとして成立しない
- **P1（高）**: MVPに含めたい機能。ユーザー体験を大きく向上させる
- **P2（低）**: 将来の拡張として検討。MVPでは実装しない

---

## 🔄 このドキュメントの更新ルール

1. **仕様変更時は必ず更新**: 実装中に要件が変わった場合、まずこのドキュメントを更新する
2. **変更履歴を記録**: 重要な変更は変更履歴セクションに記録する（必要に応じて）
3. **設計との整合性**: `03_conversation_model.md` や `04_api_design.md` と矛盾しないようにする
4. **実装との整合性**: 実装が要件を満たしているか定期的に確認する

---

## 📝 変更履歴

- 2024-XX-XX: 初版作成
- 2024-XX-XX: FR-3.1 を更新 - コンテキスト仕様を明確化（0階層目メッセージのうち、ツリーの最上段メッセージの作成日時以前のものだけを含める仕様に修正）
- 2024-XX-XX: FR-1.1, FR-3.1 を更新 - ツリーの最上段メッセージの概念を明確化、コンテキスト取得の手順を詳細化
- 2024-XX-XX: FR-Auth.1〜3 を追加 - 認証・セッション管理・アクセス制御の要件を明文化

